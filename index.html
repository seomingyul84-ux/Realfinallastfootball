<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>FM26 â€” Advanced</title>
<style>
/* â”€â”€ reset & vars â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
*{margin:0;padding:0;box-sizing:border-box;}
:root{
  --bg:#07100a; --bg2:#0c180d; --bg3:#101a11; --panel:#0d170e;
  --border:#182918; --green:#00ff41; --g2:#00c832; --gdim:#00441a;
  --gmute:#0d2016; --amber:#ffb700; --red:#ff3c3c; --blue:#33ccff;
  --text:#b5d8b5; --tdim:#385838;
}
html,body{height:100%;overflow:hidden;}
body{background:var(--bg);color:var(--text);font-family:monospace;display:flex;flex-direction:column;}

/* â”€â”€ header â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
header{
  background:var(--bg2);border-bottom:2px solid var(--gdim);
  height:42px;display:flex;align-items:center;justify-content:space-between;
  padding:0 16px;flex-shrink:0;
}
.logo{font-size:18px;font-weight:900;color:var(--green);letter-spacing:-1px;text-shadow:0 0 14px rgba(0,255,65,.5);}
.logo em{color:var(--tdim);font-style:normal;}
.logo small{font-size:9px;color:var(--tdim);font-weight:400;margin-left:6px;}
.hinfo{font-size:9px;color:var(--tdim);text-align:right;line-height:1.7;}

/* â”€â”€ momentum strip â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.mstrip{height:5px;background:linear-gradient(90deg,var(--red) 0%,#333 45%,#333 55%,var(--green) 100%);flex-shrink:0;position:relative;}
.mind{position:absolute;top:-1px;width:4px;height:7px;background:#fff;border-radius:1px;box-shadow:0 0 6px #fff;transform:translateX(-50%);transition:left .35s ease;left:50%;}
.mlab{position:absolute;top:6px;font-size:8px;color:var(--tdim);letter-spacing:1px;}
.mlab.left{left:4px;}
.mlab.right{right:4px;}

/* â”€â”€ main grid â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.main{flex:1;display:grid;grid-template-columns:200px 1fr 280px;overflow:hidden;min-height:0;}

/* â”€â”€ sidebar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.sidebar{background:var(--panel);border-right:1px solid var(--border);overflow-y:auto;padding:10px 9px;display:flex;flex-direction:column;gap:10px;}
.slabel{font-size:8px;letter-spacing:2px;color:var(--tdim);text-transform:uppercase;padding-bottom:4px;border-bottom:1px solid var(--border);margin-bottom:3px;}
.slabel2{font-size:8px;color:var(--tdim);display:block;margin-bottom:3px;letter-spacing:1px;}
.fgrid{display:grid;grid-template-columns:repeat(3,1fr);gap:3px;}
.fbtn{background:var(--bg3);border:1px solid var(--border);color:var(--tdim);font-family:monospace;font-size:8px;font-weight:700;padding:5px 1px;cursor:pointer;text-align:center;transition:.12s;}
.fbtn:hover{color:var(--text);border-color:var(--gdim);}
.fbtn.active{background:var(--gmute);border-color:var(--g2);color:var(--green);}
select{width:100%;background:var(--bg3);border:1px solid var(--border);color:var(--text);font-family:monospace;font-size:10px;padding:4px 6px;outline:none;cursor:pointer;appearance:none;}
.slrow{display:flex;gap:4px;align-items:center;}
.slrow input{flex:1;accent-color:var(--g2);}
.slval{font-size:9px;color:var(--green);width:12px;text-align:right;}
.plist{display:flex;flex-direction:column;}
.pitem{display:flex;align-items:center;gap:4px;padding:3px 2px;border-bottom:1px solid var(--border);font-size:10px;cursor:default;}
.pitem:hover{background:var(--bg3);}
.pnum{font-size:8px;color:var(--tdim);width:14px;text-align:right;}
.pbadge{font-size:7px;font-weight:700;background:var(--gmute);color:var(--g2);border:1px solid var(--gdim);padding:1px 3px;min-width:22px;text-align:center;}
.pname{flex:1;}
.prtg{font-size:8px;color:var(--amber);}
.pico{font-size:8px;width:10px;}

/* â”€â”€ center (pitch area) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.center{
  display:flex;flex-direction:column;align-items:center;justify-content:center;
  background:var(--bg);overflow:hidden;padding:8px;gap:8px;
}

/* minute + controls row */
.topbar{display:flex;align-items:center;gap:12px;flex-shrink:0;}
.minbox{font-size:12px;color:var(--tdim);letter-spacing:2px;}
.minbox span{color:var(--green);font-size:16px;font-weight:900;}

/* PITCH CONTAINER â€” fills available space, maintains 300:460 ratio */
.pitch-outer{
  position:relative;flex:1;width:100%;display:flex;align-items:center;justify-content:center;min-height:0;
}
.pitch{
  background:#164d16;border:2px solid #256025;
  position:relative;overflow:hidden;
  /* size set by JS */
}
.pitch::before{
  content:'';position:absolute;inset:0;
  background:repeating-linear-gradient(180deg,transparent 0,transparent 38px,rgba(0,0,0,.08) 38px,rgba(0,0,0,.08) 76px);
  pointer-events:none;z-index:0;
}
.pitch>svg,
.pitch>canvas{position:absolute;inset:0;pointer-events:none;}
#pitchSvg {z-index:1;}
#heatSvg  {z-index:2;opacity:.5;}
#passSvg  {z-index:3;}
#trajSvg  {z-index:8;}

/* ball */
.ball{
  position:absolute;border-radius:50%;
  background:radial-gradient(circle at 35% 35%,#fff,#ccc);
  border:1px solid #aaa;
  box-shadow:0 0 8px rgba(255,255,255,.85),0 2px 5px rgba(0,0,0,.7);
  transform:translate(-50%,-50%);z-index:12;pointer-events:none;
  transition:left .16s linear,top .16s linear;
}

/* player dots */
.pdot{position:absolute;transform:translate(-50%,-50%);display:flex;flex-direction:column;align-items:center;gap:1px;z-index:10;}
.pcirc{border-radius:50%;background:var(--g2);border:2px solid var(--green);display:flex;align-items:center;justify-content:center;font-weight:700;color:#000;box-shadow:0 0 6px rgba(0,200,50,.4);transition:box-shadow .15s,border-color .15s;}
.pcirc.opp{background:var(--red);border-color:#ff7070;color:#fff;box-shadow:0 0 6px rgba(255,60,60,.4);}
.pcirc.pressing{box-shadow:0 0 16px rgba(255,180,0,1)!important;border-color:var(--amber)!important;}
.pcirc.running {box-shadow:0 0 16px rgba(50,200,255,1)!important;border-color:var(--blue)!important;}
.ptag{font-size:7px;color:#fff;background:rgba(0,0,0,.82);padding:1px 3px;white-space:nowrap;}

/* controls */
.controls{display:flex;gap:6px;align-items:center;flex-shrink:0;}
.btn-sim{background:var(--g2);color:#000;border:none;cursor:pointer;font-family:monospace;font-size:13px;font-weight:900;letter-spacing:1px;padding:9px 22px;transition:.14s;text-transform:uppercase;}
.btn-sim:hover:not(:disabled){background:var(--green);}
.btn-sim:disabled{opacity:.38;cursor:not-allowed;}
.btn-sm{background:transparent;color:var(--tdim);border:1px solid var(--border);font-family:monospace;font-size:9px;padding:7px 10px;cursor:pointer;transition:.14s;}
.btn-sm:hover{color:var(--text);border-color:var(--tdim);}
.btn-sm.on{background:var(--gmute);color:var(--green);border-color:var(--gdim);}

/* â”€â”€ right panel â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.rpanel{background:var(--panel);border-left:1px solid var(--border);display:flex;flex-direction:column;overflow:hidden;}
.rhead{padding:10px 12px 8px;border-bottom:1px solid var(--border);flex-shrink:0;}
.scoreboard{display:flex;align-items:center;justify-content:center;gap:8px;margin:5px 0;}
.tname{font-size:10px;font-weight:700;color:var(--tdim);text-align:center;max-width:60px;line-height:1.2;}
.tname.my{color:var(--green);}
.score{font-size:26px;font-weight:900;color:var(--green);letter-spacing:-2px;min-width:72px;text-align:center;text-shadow:0 0 14px rgba(0,255,65,.3);}
.mstatus{text-align:center;font-size:8px;color:var(--tdim);letter-spacing:2px;margin-top:2px;}
.mstatus.live{color:var(--green);animation:blink 1s infinite;}
@keyframes blink{0%,100%{opacity:1}50%{opacity:.2}}

/* tabs */
.tabs{display:flex;border-bottom:1px solid var(--border);flex-shrink:0;}
.tab{flex:1;padding:6px 3px;text-align:center;font-size:8px;letter-spacing:1px;color:var(--tdim);cursor:pointer;border-bottom:2px solid transparent;transition:.13s;text-transform:uppercase;}
.tab.active{color:var(--green);border-bottom-color:var(--green);}
.tpane{display:none;flex:1;overflow-y:auto;flex-direction:column;}
.tpane.active{display:flex;}

/* log */
.log{flex:1;overflow-y:auto;padding:7px 9px;display:flex;flex-direction:column;gap:2px;}
.lentry{display:flex;gap:5px;align-items:flex-start;padding:3px 0;border-bottom:1px solid rgba(24,41,24,.4);opacity:0;animation:fi .2s forwards;}
@keyframes fi{to{opacity:1}}
.lmin{font-size:8px;color:var(--tdim);width:20px;flex-shrink:0;margin-top:1px;}
.lic{width:13px;flex-shrink:0;font-size:10px;}
.ltxt{font-size:10px;line-height:1.4;flex:1;}
.ltxt b{color:var(--green);}
.ltxt.opp b{color:var(--red);}
.ltxt.gmy{color:var(--green);font-weight:700;font-size:11px;}
.ltxt.gopp{color:var(--red);font-weight:700;font-size:11px;}
.ltxt.amb{color:var(--amber);font-size:9px;}

/* stats */
.stsec{padding:8px 11px;border-bottom:1px solid var(--border);}
.xgrow{display:flex;justify-content:space-between;align-items:center;padding:6px 0;}
.xgval{font-size:18px;font-weight:900;color:var(--amber);}
.xglbl{font-size:8px;color:var(--tdim);letter-spacing:1px;margin-top:1px;}
.barrow{display:flex;align-items:center;gap:5px;margin-bottom:5px;}
.barlbl{font-size:8px;color:var(--tdim);width:50px;text-align:right;flex-shrink:0;}
.barwrap{flex:1;height:5px;background:var(--bg3);border-radius:3px;overflow:hidden;position:relative;}
.barmy{height:100%;background:var(--g2);border-radius:3px;position:absolute;right:50%;transition:width .4s;}
.baropp{height:100%;background:var(--red);border-radius:3px;position:absolute;left:50%;transition:width .4s;}
.barval{font-size:8px;width:40px;flex-shrink:0;color:var(--tdim);}
.barval.hi{color:var(--green);}

/* player table */
.ptab{width:100%;border-collapse:collapse;font-size:9px;}
.ptab th{font-size:7px;color:var(--tdim);letter-spacing:1px;padding:4px 3px;text-align:center;border-bottom:1px solid var(--border);text-transform:uppercase;}
.ptab td{padding:3px;text-align:center;border-bottom:1px solid rgba(24,41,24,.3);}
.ptab td:first-child{text-align:left;}
.ptab tr:hover td{background:var(--bg3);}
.rhi{color:var(--green);font-weight:700;}
.rmd{color:var(--amber);font-weight:700;}
.rlo{color:var(--red);font-weight:700;}

.empty{display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%;color:var(--tdim);font-size:8px;letter-spacing:2px;gap:8px;text-transform:uppercase;}
.empty .big{font-size:34px;opacity:.14;}
::-webkit-scrollbar{width:3px;}
::-webkit-scrollbar-thumb{background:var(--gdim);}
</style>
</head>
<body>

<header>
  <div class="logo">FM<em>/</em>26<small>advanced engine</small></div>
  <div class="hinfo">ì‹œì¦Œ 2025/26 Â· 1ë¼ìš´ë“œ<br>í™ˆ ê²½ê¸°</div>
</header>

<div class="mstrip">
  <div class="mind" id="mind"></div>
  <span class="mlab left">ìƒëŒ€ ìš°ìœ„</span>
  <span class="mlab right">ìš°ë¦¬ ìš°ìœ„</span>
</div>

<div class="main">

  <!-- SIDEBAR -->
  <div class="sidebar">
    <div>
      <div class="slabel">í¬ë©”ì´ì…˜</div>
      <div class="fgrid" id="fgrid"></div>
    </div>
    <div>
      <div class="slabel">ì „ìˆ </div>
      <div style="margin-bottom:7px"><span class="slabel2">í”Œë ˆì´ ìŠ¤íƒ€ì¼</span>
        <select id="pstyle"><option>ì ìœ  ì¶•êµ¬</option><option>ë¹ ë¥¸ ì—­ìŠµ</option><option>ì••ë°• ì „ì§„</option><option>ìˆ˜ë¹„ í›„ ì—­ìŠµ</option><option>ì§ì ‘ ë¡±ë³¼</option></select>
      </div>
      <div style="margin-bottom:7px"><span class="slabel2">ì••ë°• ê°•ë„</span>
        <div class="slrow"><input type="range" id="press" min="1" max="10" value="6"><span class="slval" id="pressv">6</span></div>
      </div>
      <div style="margin-bottom:7px"><span class="slabel2">ìˆ˜ë¹„ ë¼ì¸</span>
        <select id="defline"><option>ê¹Šì€ ìˆ˜ë¹„</option><option>ì¤‘ê°„</option><option>ë†’ì€ ìˆ˜ë¹„</option></select>
      </div>
      <div><span class="slabel2">í…œí¬</span>
        <div class="slrow"><input type="range" id="tempo" min="1" max="10" value="6"><span class="slval" id="tempov">6</span></div>
      </div>
    </div>
    <div>
      <div class="slabel">ì„ ìˆ˜ë‹¨</div>
      <div class="plist" id="plist"></div>
    </div>
  </div>

  <!-- CENTER: PITCH -->
  <div class="center">
    <div class="topbar">
      <div class="minbox">ê²½ê¸°ì‹œê°„ <span id="minDisp">0</span>'</div>
    </div>

    <div class="pitch-outer" id="pitchOuter">
      <div class="pitch" id="pitch">
        <svg id="pitchSvg"></svg>
        <canvas id="heatCanvas"></canvas>
        <svg id="passSvg"></svg>
        <svg id="trajSvg"></svg>
        <div class="ball" id="ball" style="left:50%;top:50%"></div>
      </div>
    </div>

    <div class="controls">
      <button class="btn-sim" id="simBtn">âš½ ê²½ê¸° ì‹œì‘</button>
      <button class="btn-sm" id="rstBtn">ì´ˆê¸°í™”</button>
      <button class="btn-sm" id="heatBtn">íˆíŠ¸ë§µ</button>
      <button class="btn-sm" id="passBtn">íŒ¨ìŠ¤ë§µ</button>
    </div>
  </div>

  <!-- RIGHT PANEL -->
  <div class="rpanel">
    <div class="rhead">
      <div class="slabel">ê²½ê¸° í˜„í™©</div>
      <div class="scoreboard">
        <div class="tname my">ìš°ë¦¬íŒ€</div>
        <div class="score" id="score">- : -</div>
        <div class="tname">FC ë¼ì´ë²Œ</div>
      </div>
      <div class="mstatus" id="mstatus">ê²½ê¸° ì „</div>
    </div>
    <div class="tabs">
      <div class="tab active" data-tab="log">ì¤‘ê³„</div>
      <div class="tab" data-tab="stats">ìŠ¤íƒ¯</div>
      <div class="tab" data-tab="players">ì„ ìˆ˜</div>
    </div>
    <div class="tpane active" id="tlog">
      <div class="log" id="log">
        <div class="empty"><div class="big">ğŸŸ</div><div>ê²½ê¸° ì‹œì‘ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”</div></div>
      </div>
    </div>
    <div class="tpane" id="tstats">
      <div class="stsec">
        <div class="xgrow">
          <div style="text-align:center"><div class="xgval" id="xgMy">0.00</div><div class="xglbl">ìš°ë¦¬íŒ€ xG</div></div>
          <div style="font-size:8px;color:var(--tdim)">ê¸°ëŒ€ ê³¨</div>
          <div style="text-align:center"><div class="xgval" id="xgOpp">0.00</div><div class="xglbl">ìƒëŒ€ xG</div></div>
        </div>
      </div>
      <div class="stsec" id="statBars"></div>
    </div>
    <div class="tpane" id="tplayers">
      <div style="padding:7px 10px;overflow-x:auto;">
        <table class="ptab">
          <thead><tr><th>ì„ ìˆ˜</th><th>ìŠˆíŒ…</th><th>íŒ¨ìŠ¤</th><th>í„°ì¹˜</th><th>í‰ì </th></tr></thead>
          <tbody id="ptbody"></tbody>
        </table>
      </div>
    </div>
  </div>

</div>

<script src="engine.js"></script>
<script>
// ============================================================
//  RENDERER â€” DOM + canvas drawing
// ============================================================
var PW=300, PH=460;
var pitchW=PW, pitchH=PH;
var viewMode='none'; // 'heat' | 'pass' | 'none'
var heatmapAccum=[];
var ICONS={gmy:'âš½',gopp:'ğŸ’¥',shot:'ğŸ¯',save:'ğŸ§¤',pass:'ğŸ”„',press:'ğŸ’¨',foul:'ğŸŸ¡',danger:'âš ï¸',amb:'ğŸ“Š'};

// â”€â”€ pitch sizing â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function sizePitch(){
  var outer=document.getElementById('pitchOuter');
  var ow=outer.clientWidth-16, oh=outer.clientHeight-16;
  // maintain 300:460 aspect ratio
  var scaleH=oh/PH, scaleW=ow/PW;
  var scale=Math.min(scaleH,scaleW,1.4); // allow up to 1.4x
  pitchW=Math.round(PW*scale);
  pitchH=Math.round(PH*scale);

  var pitch=document.getElementById('pitch');
  pitch.style.width=pitchW+'px';
  pitch.style.height=pitchH+'px';

  // set all SVG viewboxes
  ['pitchSvg','passSvg','trajSvg'].forEach(function(id){
    var el=document.getElementById(id);
    el.setAttribute('viewBox','0 0 '+pitchW+' '+pitchH);
    el.setAttribute('width',pitchW);
    el.setAttribute('height',pitchH);
  });

  var hc=document.getElementById('heatCanvas');
  hc.width=pitchW; hc.height=pitchH;

  var ball=document.getElementById('ball');
  var bs=Math.round(pitchW*0.052);
  ball.style.width=bs+'px'; ball.style.height=bs+'px';

  drawPitchLines();
  renderFormation();
}

// â”€â”€ pitch lines â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function drawPitchLines(){
  var W=pitchW,H=pitchH;
  var s=document.getElementById('pitchSvg');
  s.innerHTML=[
    '<g fill="none" stroke="#256025" stroke-width="1.2">',
    '<rect x="1" y="1" width="'+(W-2)+'" height="'+(H-2)+'"/>',
    '<line x1="1" y1="'+(H*.5)+'" x2="'+(W-1)+'" y2="'+(H*.5)+'"/>',
    '<circle cx="'+(W*.5)+'" cy="'+(H*.5)+'" r="'+(W*.154)+'"/>',
    '<circle cx="'+(W*.5)+'" cy="'+(H*.5)+'" r="2" fill="#256025"/>',
    '<rect x="'+(W*.218)+'" y="1" width="'+(W*.564)+'" height="'+(H*.19)+'"/>',
    '<rect x="'+(W*.218)+'" y="'+(H*.81)+'" width="'+(W*.564)+'" height="'+(H*.19)+'"/>',
    '<rect x="'+(W*.36)+'" y="1" width="'+(W*.28)+'" height="'+(H*.082)+'"/>',
    '<rect x="'+(W*.36)+'" y="'+(H*.918)+'" width="'+(W*.28)+'" height="'+(H*.082)+'"/>',
    '<circle cx="'+(W*.5)+'" cy="'+(H*.162)+'" r="2" fill="#256025"/>',
    '<circle cx="'+(W*.5)+'" cy="'+(H*.838)+'" r="2" fill="#256025"/>',
    '</g>'
  ].join('');
}

// â”€â”€ formation render â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderFormation(){
  var pitch=document.getElementById('pitch');
  pitch.querySelectorAll('.pdot').forEach(function(e){e.remove();});

  var curF=document.querySelector('.fbtn.active');
  var fname=curF?curF.dataset.f:'4-4-2';
  var pos=FM26Engine.FORMATIONS[fname];
  if(!pos) return;
  var sq=FM26Engine.State.players||FM26Engine.makeSquad();
  var op=FM26Engine.State.opps  ||FM26Engine.makeOppSquad();

  pos.forEach(function(p,i){
    var pl=sq[i]||{num:i+1,name:'?'};
    pitch.appendChild(makeDot(p[0],p[1],pl.num,pl.name,false,i));
  });
  pos.forEach(function(p,i){
    var op2=op[i]||{name:'?'};
    pitch.appendChild(makeDot(p[0],100-p[1],i+1,op2.name,true,i));
  });
}

function makeDot(xp,yp,num,name,isOpp,idx){
  var sz=Math.round(pitchW*0.088);
  var dot=document.createElement('div');
  dot.className='pdot';
  dot.id=(isOpp?'opp':'my')+idx;
  dot.style.left=xp+'%'; dot.style.top=yp+'%';
  dot.style.transition='left .28s ease,top .28s ease';

  var c=document.createElement('div');
  c.className='pcirc'+(isOpp?' opp':'');
  c.style.width=sz+'px'; c.style.height=sz+'px';
  c.style.fontSize=Math.round(sz*.33)+'px';
  c.textContent=num;

  var t=document.createElement('div');
  t.className='ptag';
  t.textContent=name.length>4?name.slice(0,4):name;

  dot.appendChild(c); dot.appendChild(t);
  return dot;
}

// â”€â”€ trajectory animation â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function drawTrajectory(x1p,y1p,x2p,y2p,type,onDone){
  var svg=document.getElementById('trajSvg');
  var x1=x1p/100*pitchW, y1=y1p/100*pitchH;
  var x2=x2p/100*pitchW, y2=y2p/100*pitchH;
  var col=type==='SHOOT'||type==='LONGSHOT'?'#ffb700':type==='THROUGH'?'#33ccff':'#00c832';
  var lift=type==='LONGSHOT'?-65:type==='SHOOT'?-35:-18;
  var mx=(x1+x2)*.5, my=(y1+y2)*.5+lift;

  var path=document.createElementNS('http://www.w3.org/2000/svg','path');
  path.setAttribute('d','M'+x1+','+y1+' Q'+mx+','+my+' '+x2+','+y2);
  path.setAttribute('fill','none');
  path.setAttribute('stroke',col);
  path.setAttribute('stroke-width',type==='SHOOT'||type==='LONGSHOT'?2.5:1.8);
  path.setAttribute('stroke-linecap','round');
  path.setAttribute('opacity','0');
  svg.appendChild(path);

  // animate: fade in draw via strokeDashoffset
  var len=path.getTotalLength()||120;
  path.setAttribute('stroke-dasharray',len);
  path.setAttribute('stroke-dashoffset',len);

  requestAnimationFrame(function(){
    path.style.transition='stroke-dashoffset .22s ease, opacity .1s';
    path.setAttribute('opacity','0.9');
    path.style.strokeDashoffset='0';
  });

  // move ball
  var ball=document.getElementById('ball');
  ball.style.transition='left .22s linear,top .22s linear';
  ball.style.left=x2p+'%'; ball.style.top=y2p+'%';

  setTimeout(function(){
    path.style.transition='opacity .3s';
    path.setAttribute('opacity','0');
    setTimeout(function(){
      if(svg.contains(path)) svg.removeChild(path);
      if(onDone) onDone();
    },300);
  },260);
}

// â”€â”€ heatmap â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function drawHeatmap(data){
  var canvas=document.getElementById('heatCanvas');
  var ctx=canvas.getContext('2d');
  ctx.clearRect(0,0,pitchW,pitchH);
  data.forEach(function(pt){
    var x=pt.x/100*pitchW, y=pt.y/100*pitchH;
    var r=pitchW*.09;
    var g=ctx.createRadialGradient(x,y,0,x,y,r);
    var col=pt.team==='my'?'0,200,50':'255,60,60';
    g.addColorStop(0,'rgba('+col+',.4)');
    g.addColorStop(1,'rgba('+col+',0)');
    ctx.fillStyle=g;
    ctx.beginPath();ctx.arc(x,y,r,0,Math.PI*2);ctx.fill();
  });
}
function clearHeat(){
  var ctx=document.getElementById('heatCanvas').getContext('2d');
  ctx.clearRect(0,0,pitchW,pitchH);
}

// â”€â”€ pass map â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function drawPassMap(data,formation){
  var svg=document.getElementById('passSvg');
  svg.innerHTML='';
  var pos=FM26Engine.FORMATIONS[formation]||FM26Engine.FORMATIONS['4-4-2'];
  var counts={};
  data.forEach(function(p){
    var k=p.team+':'+p.from+'>'+p.to;
    counts[k]=(counts[k]||0)+1;
  });
  Object.keys(counts).forEach(function(k){
    var t=k.split(':');var team=t[0];
    var pair=t[1].split('>');var fi=+pair[0],ti=+pair[1];
    var fp=pos[fi],tp=pos[ti];
    if(!fp||!tp) return;
    var x1=fp[0]/100*pitchW, y1=(team==='my'?fp[1]:100-fp[1])/100*pitchH;
    var x2=tp[0]/100*pitchW, y2=(team==='my'?tp[1]:100-tp[1])/100*pitchH;
    var line=document.createElementNS('http://www.w3.org/2000/svg','line');
    line.setAttribute('x1',x1);line.setAttribute('y1',y1);
    line.setAttribute('x2',x2);line.setAttribute('y2',y2);
    line.setAttribute('stroke',team==='my'?'rgba(0,200,50,.75)':'rgba(255,60,60,.75)');
    line.setAttribute('stroke-width',Math.min(counts[k]*.8+0.5,5));
    svg.appendChild(line);
  });
  pos.forEach(function(p,i){
    ['my','opp'].forEach(function(team){
      var x=p[0]/100*pitchW, y=(team==='my'?p[1]:100-p[1])/100*pitchH;
      var c=document.createElementNS('http://www.w3.org/2000/svg','circle');
      c.setAttribute('cx',x);c.setAttribute('cy',y);c.setAttribute('r',4);
      c.setAttribute('fill',team==='my'?'#00c832':'#ff3c3c');
      c.setAttribute('opacity','.85');
      svg.appendChild(c);
    });
  });
}
function clearPass(){document.getElementById('passSvg').innerHTML='';}

// â”€â”€ player dot state â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function setDotState(idx,isOpp,state){
  var el=document.getElementById((isOpp?'opp':'my')+idx);
  if(!el) return;
  var c=el.querySelector('.pcirc');
  c.classList.remove('pressing','running');
  if(state==='PRESS') c.classList.add('pressing');
  if(state==='RUN')   c.classList.add('running');
}

// â”€â”€ tick update â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function onTick(data){
  var ball=document.getElementById('ball');
  ball.style.left=data.ballX+'%'; ball.style.top=data.ballY+'%';
  document.getElementById('minDisp').textContent=data.minute;

  // apply positioning
  data.positions.forEach(function(pos,i){
    if(!pos) return;
    var isOpp=(i%2===1);
    var idx=Math.floor(i/2);
    var el=document.getElementById((isOpp?'opp':'my')+idx);
    if(!el) return;
    el.style.left=pos.x+'%'; el.style.top=pos.y+'%';
    setDotState(idx,isOpp,pos.state);
  });
}

// â”€â”€ event update â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function onEvent(data){
  var ev=data.ev;

  // score
  document.getElementById('score').textContent=data.myScore+' : '+data.oppScore;

  // momentum
  document.getElementById('mind').style.left=(data.momentum*100)+'%';

  // xG
  document.getElementById('xgMy').textContent=data.myXG.toFixed(2);
  document.getElementById('xgOpp').textContent=data.myXG!==undefined?data.oppXG.toFixed(2):'0.00';

  // stat bars
  updateStatBars(data);

  // trajectory
  if(ev.fbx!==undefined&&ev.traj){
    drawTrajectory(ev.fbx,ev.fby,ev.bx,ev.by,ev.traj);
  } else if(ev.bx){
    var ball=document.getElementById('ball');
    ball.style.left=ev.bx+'%'; ball.style.top=ev.by+'%';
  }

  // log
  addLog(ev.min,ev.type,ev.text);
  if(data.fatigueWarning) addLog(ev.min,'shot',data.fatigueWarning);
  if(data.momentumMsg)    addLog(ev.min,'amb',data.momentumMsg);

  // overlays
  if(viewMode==='heat') drawHeatmap(data.heatmap);
  if(viewMode==='pass'){
    var f=document.querySelector('.fbtn.active');
    drawPassMap(data.passmap,f?f.dataset.f:'4-4-2');
  }

  // player table (throttle: every 5th event)
  updatePlayerTable(data.players);
}

// â”€â”€ log â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
var LOGCLS={gmy:'gmy',gopp:'gopp',shot:'',save:'opp',pass:'',press:'',foul:'',danger:'opp',amb:'amb'};
function addLog(min,type,text){
  var log=document.getElementById('log');
  if(log.querySelector('.empty')) log.innerHTML='';
  var e=document.createElement('div');
  e.className='lentry';
  var t=text;
  var allPlayers=(FM26Engine.State.players||[]).concat(FM26Engine.State.opps||[]);
  allPlayers.forEach(function(p){t=t.split(p.name).join('<b>'+p.name+'</b>');});
  e.innerHTML='<span class="lmin">'+min+"'</span>"
    +'<span class="lic">'+(ICONS[type]||'Â·')+'</span>'
    +'<span class="ltxt '+(LOGCLS[type]||'')+'">'+t+'</span>';
  log.appendChild(e);
  log.scrollTop=log.scrollHeight;
}

// â”€â”€ stat bars â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
var STATDEFS=[
  {k:'shots', lbl:'ìŠˆíŒ…',  my:function(d){return d.myShots;},  opp:function(d){return d.oppShots;}},
  {k:'passes',lbl:'íŒ¨ìŠ¤',  my:function(d){return d.myPasses;}, opp:function(d){return d.oppPasses;}},
];
function buildStatBars(){
  var div=document.getElementById('statBars');
  div.innerHTML='';
  STATDEFS.forEach(function(sd){
    var row=document.createElement('div');
    row.className='barrow';
    row.innerHTML='<div class="barval hi" id="bv_my_'+sd.k+'">0</div>'
      +'<div class="barwrap"><div class="barmy" id="bm_'+sd.k+'" style="width:0"></div><div class="baropp" id="bo_'+sd.k+'" style="width:0"></div></div>'
      +'<div class="barlbl">'+sd.lbl+'</div>'
      +'<div class="barval" id="bv_opp_'+sd.k+'">0</div>';
    div.appendChild(row);
  });
}
function updateStatBars(d){
  STATDEFS.forEach(function(sd){
    var mv=sd.my(d),ov=sd.opp(d),tot=mv+ov||1;
    var mE=document.getElementById('bv_my_'+sd.k);
    var oE=document.getElementById('bv_opp_'+sd.k);
    var bmE=document.getElementById('bm_'+sd.k);
    var boE=document.getElementById('bo_'+sd.k);
    if(!mE) return;
    mE.textContent=mv; oE.textContent=ov;
    bmE.style.width=(mv/tot*50)+'%'; boE.style.width=(ov/tot*50)+'%';
  });
}

// â”€â”€ player table â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function updatePlayerTable(players){
  var tbody=document.getElementById('ptbody');
  if(!tbody||!players) return;
  tbody.innerHTML='';
  players.forEach(function(p){
    var r=p.ms.rating.toFixed(1);
    var cls=parseFloat(r)>=7.5?'rhi':parseFloat(r)>=6.5?'rmd':'rlo';
    var tr=document.createElement('tr');
    tr.innerHTML='<td>'+p.name+'</td><td>'+p.ms.shots+'</td><td>'+p.ms.passes+'</td><td>'+p.ms.touches+'</td><td class="'+cls+'">'+r+'</td>';
    tbody.appendChild(tr);
  });
}

// â”€â”€ formation buttons â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function buildFormationBtns(){
  var grid=document.getElementById('fgrid');
  grid.innerHTML='';
  Object.keys(FM26Engine.FORMATIONS).forEach(function(f,i){
    var btn=document.createElement('button');
    btn.className='fbtn'+(i===0?' active':'');
    btn.textContent=f; btn.dataset.f=f;
    btn.addEventListener('click',function(){
      document.querySelectorAll('.fbtn').forEach(function(b){b.classList.remove('active');});
      btn.classList.add('active');
      renderFormation();
    });
    grid.appendChild(btn);
  });
}

// â”€â”€ player sidebar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function buildPlayerList(){
  FM26Engine.resetState();
  var list=document.getElementById('plist');
  var ico={BIGMATCH:'ğŸ’ª',SELFISH:'ğŸ˜¤',NERVOUS:'ğŸ˜°',NORMAL:'ğŸ˜'};
  list.innerHTML=FM26Engine.State.players.map(function(p){
    return '<div class="pitem">'
      +'<span class="pnum">'+p.num+'</span>'
      +'<span class="pbadge">'+p.pos+'</span>'
      +'<span class="pname">'+p.name+'</span>'
      +'<span class="pico">'+(ico[p.personality]||'ğŸ˜')+'</span>'
      +'<span class="prtg">'+p.rtg+'</span>'
      +'</div>';
  }).join('');
}

// â”€â”€ simulation control â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.getElementById('simBtn').addEventListener('click',function(){
  if(FM26Engine.State.running) return;
  FM26Engine.resetState();
  document.getElementById('score').textContent='0 : 0';
  document.getElementById('mstatus').textContent='ì§„í–‰ì¤‘ â—';
  document.getElementById('mstatus').className='mstatus live';
  document.getElementById('log').innerHTML='';
  document.getElementById('ptbody').innerHTML='';
  document.getElementById('simBtn').disabled=true;
  clearHeat(); clearPass();
  heatmapAccum=[];

  var press=parseInt(document.getElementById('press').value);
  var tempo=parseInt(document.getElementById('tempo').value);
  var curF=document.querySelector('.fbtn.active');
  var formation=curF?curF.dataset.f:'4-4-2';

  FM26Engine.runSimulation(press,tempo,{
    onStart:function(){},
    onTick:onTick,
    onEvent:onEvent,
    onEnd:function(d){
      var res=d.myScore>d.oppScore?'ìŠ¹ë¦¬! ğŸ‰':d.myScore<d.oppScore?'íŒ¨ë°°...':'ë¬´ìŠ¹ë¶€';
      addLog(90,'gmy','ğŸ ê²½ê¸° ì¢…ë£Œ â€” '+res+' ('+d.myScore+':'+d.oppScore+')');
      addLog(90,'amb','xG ìš°ë¦¬ '+d.myXG.toFixed(2)+' vs ìƒëŒ€ '+d.oppXG.toFixed(2));
      document.getElementById('mstatus').textContent='ê²½ê¸° ì¢…ë£Œ';
      document.getElementById('mstatus').className='mstatus';
      document.getElementById('simBtn').disabled=false;
      document.getElementById('minDisp').textContent='90';
      updatePlayerTable(d.players);
      if(viewMode==='heat') drawHeatmap(FM26Engine.State.heatmap);
      if(viewMode==='pass'){
        var f=document.querySelector('.fbtn.active');
        drawPassMap(FM26Engine.State.passmap,f?f.dataset.f:'4-4-2');
      }
    }
  },formation);
});

document.getElementById('rstBtn').addEventListener('click',function(){
  FM26Engine.stopSimulation();
  setTimeout(function(){   // stopì´ asyncë¼ í•œ í‹± ë’¤ì— ë¦¬ì…‹
    FM26Engine.resetState();
    document.getElementById('score').textContent='- : -';
    document.getElementById('mstatus').textContent='ê²½ê¸° ì „';
    document.getElementById('mstatus').className='mstatus';
    document.getElementById('minDisp').textContent='0';
    document.getElementById('mind').style.left='50%';
    document.getElementById('simBtn').disabled=false;
    document.getElementById('log').innerHTML='<div class="empty"><div class="big">ğŸŸ</div><div>ê²½ê¸° ì‹œì‘ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”</div></div>';
    document.getElementById('ball').style.left='50%';
    document.getElementById('ball').style.top='50%';
    clearHeat(); clearPass();
    renderFormation();
    document.getElementById('ptbody').innerHTML='';
    document.getElementById('xgMy').textContent='0.00';
    document.getElementById('xgOpp').textContent='0.00';
  }, 50);
});

// â”€â”€ overlay buttons â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.getElementById('heatBtn').addEventListener('click',function(){
  viewMode=viewMode==='heat'?'none':'heat';
  this.classList.toggle('on',viewMode==='heat');
  document.getElementById('passBtn').classList.remove('on');
  if(viewMode==='heat') drawHeatmap(FM26Engine.State.heatmap); else clearHeat();
  if(viewMode!=='pass') clearPass();
});
document.getElementById('passBtn').addEventListener('click',function(){
  viewMode=viewMode==='pass'?'none':'pass';
  this.classList.toggle('on',viewMode==='pass');
  document.getElementById('heatBtn').classList.remove('on');
  if(viewMode==='pass'){
    var f=document.querySelector('.fbtn.active');
    drawPassMap(FM26Engine.State.passmap,f?f.dataset.f:'4-4-2');
  } else clearPass();
  if(viewMode!=='heat') clearHeat();
});

// â”€â”€ tabs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.querySelectorAll('.tab').forEach(function(tab){
  tab.addEventListener('click',function(){
    document.querySelectorAll('.tab').forEach(function(t){t.classList.remove('active');});
    document.querySelectorAll('.tpane').forEach(function(p){p.classList.remove('active');});
    tab.classList.add('active');
    document.getElementById('t'+tab.dataset.tab).classList.add('active');
  });
});

// â”€â”€ sliders â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.getElementById('press').addEventListener('input',function(){document.getElementById('pressv').textContent=this.value;});
document.getElementById('tempo').addEventListener('input',function(){document.getElementById('tempov').textContent=this.value;});

// â”€â”€ resize â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.addEventListener('resize',function(){sizePitch();});

// â”€â”€ boot â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
buildFormationBtns();
buildStatBars();
buildPlayerList();
// requestAnimationFrameìœ¼ë¡œ ë ˆì´ì•„ì›ƒ ì™„ì„± í›„ í”¼ì¹˜ í¬ê¸° ê³„ì‚°
requestAnimationFrame(function(){
  requestAnimationFrame(function(){
    sizePitch();
  });
});
</script>
</body>
</html>
